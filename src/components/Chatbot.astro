---
interface Props {
  context: 'asesorias' | 'consulta-ia';
  title: string;
  initialMessage: string;
}

const { context, title, initialMessage } = Astro.props;
---

<div id={`chatbot-modal-${context}`} class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
  <div class="bg-[#1a1a1a] rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl border border-white/10">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#82e256] to-[#6bc73d] flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-white">{title}</h3>
          <p class="text-xs text-white/60">Powered by OpenAI GPT-4</p>
        </div>
      </div>
      <button class={`close-chatbot-btn-${context} text-white/60 hover:text-white transition-colors`}>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Messages Container -->
    <div id={`chat-messages-${context}`} class="flex-1 overflow-y-auto p-4 space-y-4">
      <!-- Initial Message -->
      <div class="flex gap-3">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#82e256] to-[#6bc73d] flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <div class="bg-white/5 backdrop-blur-sm rounded-lg p-3 border border-white/10">
            <p class="text-sm text-white/90">{initialMessage}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Form -->
    <div class="p-4 border-t border-white/10">
      <form id={`chat-form-${context}`} class="flex gap-2">
        <input
          type="text"
          id={`chat-input-${context}`}
          placeholder="Escribe tu pregunta..."
          class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#82e256] focus:border-transparent backdrop-blur-sm"
          required
        />
        <button
          type="submit"
          class="bg-gradient-to-r from-[#82e256] to-[#6bc73d] hover:from-[#6bc73d] hover:to-[#5ba62e] text-black px-6 py-3 rounded-xl transition-all duration-300 flex items-center gap-2 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          <span>Enviar</span>
        </button>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ context }}>
  // Historial de conversación
  let conversationHistory = [];

  function addMessage(content, isUser, contextId) {
    const messagesContainer = document.getElementById(`chat-messages-${contextId}`);
    if (!messagesContainer) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex gap-3';

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="flex-1"></div>
        <div class="flex-1 max-w-md">
          <div class="bg-gradient-to-r from-[#82e256] to-[#6bc73d] rounded-lg p-3 ml-auto">
            <p class="text-sm text-black font-medium">${content}</p>
          </div>
        </div>
        <div class="w-8 h-8 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center flex-shrink-0 border border-white/20">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
      `;
      conversationHistory.push({ role: 'user', content: content });
    } else {
      messageDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#82e256] to-[#6bc73d] flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <div class="bg-white/5 backdrop-blur-sm rounded-lg p-3 border border-white/10">
            <div class="text-sm text-white/90 chatbot-response">${content}</div>
          </div>
        </div>
      `;
      conversationHistory.push({ role: 'assistant', content: content });
    }

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addLoadingMessage(contextId) {
    const messagesContainer = document.getElementById(`chat-messages-${contextId}`);
    if (!messagesContainer) return;

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'flex gap-3';
    loadingDiv.id = `loading-message-${contextId}`;
    loadingDiv.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#82e256] to-[#6bc73d] flex items-center justify-center flex-shrink-0">
        <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
      </div>
      <div class="flex-1">
        <div class="bg-white/5 backdrop-blur-sm rounded-lg p-3 border border-white/10">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-[#82e256] rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-[#82e256] rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-[#82e256] rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          </div>
        </div>
      </div>
    `;

    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function removeLoadingMessage(contextId) {
    const loadingMessage = document.getElementById(`loading-message-${contextId}`);
    if (loadingMessage) {
      loadingMessage.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const chatbotModal = document.getElementById(`chatbot-modal-${context}`);
    const closeChatbotBtn = document.querySelector(`.close-chatbot-btn-${context}`);
    const chatForm = document.getElementById(`chat-form-${context}`);
    const chatInput = document.getElementById(`chat-input-${context}`);

    // Abrir modal desde botones externos
    document.addEventListener('click', (e) => {
      if (e.target.closest(`[data-chatbot="${context}"]`)) {
        chatbotModal?.classList.remove('hidden');
        chatInput?.focus();
      }
    });

    // Cerrar modal
    closeChatbotBtn?.addEventListener('click', () => {
      chatbotModal?.classList.add('hidden');
    });

    chatbotModal?.addEventListener('click', (e) => {
      if (e.target === chatbotModal) {
        chatbotModal.classList.add('hidden');
      }
    });

    // Manejar envío de mensajes
    chatForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const question = chatInput.value.trim();
      if (!question) return;

      addMessage(question, true, context);
      chatInput.value = '';
      addLoadingMessage(context);

      try {
        const response = await fetch('/api/chat-assistant.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            question: question,
            conversationHistory: conversationHistory,
            context: context
          }),
        });

        removeLoadingMessage(context);

        if (response.ok) {
          const data = await response.json();
          addMessage(data.response || 'No pude procesar tu pregunta.', false, context);
        } else {
          addMessage('Lo siento, hubo un error al procesar tu pregunta. Por favor intenta de nuevo.', false, context);
        }
      } catch (error) {
        removeLoadingMessage(context);
        addMessage('Error de conexión. Por favor verifica tu conexión a internet.', false, context);
        console.error('Error:', error);
      }
    });
  });
</script>

<style>
  /* Estilos para las respuestas HTML del chatbot */
  :global(.chatbot-response p) {
    margin-bottom: 0.75rem;
  }

  :global(.chatbot-response p:last-child) {
    margin-bottom: 0;
  }

  :global(.chatbot-response strong) {
    font-weight: 600;
    color: #82e256;
  }

  :global(.chatbot-response ul) {
    list-style: disc;
    margin-left: 1.25rem;
    margin-bottom: 0.75rem;
  }

  :global(.chatbot-response li) {
    margin-bottom: 0.5rem;
  }

  :global(.chatbot-response code) {
    background: rgba(130, 226, 86, 0.1);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: monospace;
    font-size: 0.875em;
    color: #82e256;
  }

  :global(.chatbot-response a) {
    color: #82e256;
    text-decoration: underline;
    transition: color 0.2s;
  }

  :global(.chatbot-response a:hover) {
    color: #6bc73d;
  }
</style>
